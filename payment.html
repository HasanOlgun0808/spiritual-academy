<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>âœ¨ Spiritual Academy</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding-top: 50px;
        background: #faf8ff;
      }
      button {
        background-color: #8b5cf6;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        margin: 10px;
        font-size: 16px;
      }
      button:disabled {
        background-color: #c4b5fd;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <h1>âœ¨ Spiritual Academy</h1>
    <p>Pi ile Ã¶deme yapabilirsiniz.</p>
    <button id="login">ðŸ”‘ Pi ile GiriÅŸ Yap</button>
    <button id="pay" disabled>ðŸ’œ 5.99 Pi ile Ã–de</button>

    <script>
      const backendURL = "https://spiritual-academy.onrender.com";
      Pi.init({ version: "2.0", sandbox: false });

      async function onIncompletePaymentFound(payment) {
        console.log("Eksik Ã¶deme bulundu:", payment);
      }

      const loginButton = document.getElementById("login");
      const payButton = document.getElementById("pay");
      let user = null;

      loginButton.addEventListener("click", async () => {
        try {
          user = await Pi.authenticate(
            ["username", "payments"],
            onIncompletePaymentFound
          );
          alert("GiriÅŸ baÅŸarÄ±lÄ±: @" + user.username);
          payButton.disabled = false;
        } catch (err) {
          alert("GiriÅŸ baÅŸarÄ±sÄ±z: " + err);
        }
      });

      payButton.addEventListener("click", async () => {
        if (!user) return alert("LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n.");

        const paymentData = {
          amount: 5.99,
          memo: "Spiritual Academy - Nefes ve Meditasyon",
          metadata: { type: "kurs", ad: "Nefes ve Meditasyon" },
        };

        try {
          const payment = await Pi.createPayment(paymentData, {
            onReadyForServerApproval: async (paymentId) => {
              await fetch(`${backendURL}/approve-payment`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId }),
              });
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
              await fetch(`${backendURL}/complete-payment`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId, txid }),
              });
              alert("Ã–deme tamamlandÄ±!");
            },
            onCancel: (paymentId) => {
              alert("Ã–deme iptal edildi.");
            },
            onError: (err, payment) => {
              alert("Hata oluÅŸtu: " + err);
            },
          });
        } catch (err) {
          alert("Ã–deme baÅŸlatÄ±lamadÄ±: " + err);
        }
      });
    </script>
  </body>
</html>
