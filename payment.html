<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spiritual Academy | Pi Ã–deme</title>
</head>
<body>
  <h2>âœ¨ Spiritual Academy</h2>
  <p>Pi ile Ã¶deme yapabilirsiniz.</p>

  <button id="login">ðŸ”‘ Pi ile GiriÅŸ Yap</button>
  <button id="pay" disabled>ðŸ’œ 5.99 Pi ile Ã–de</button>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    const appId = "spiritual-academy";
    const backend = "https://spiritual-academy.onrender.com";

    Pi.init({ version: "2.0", sandbox: false });

    const loginBtn = document.getElementById("login");
    const payBtn = document.getElementById("pay");
    let user = null;

    // ðŸ”¹ GiriÅŸ
    loginBtn.onclick = async () => {
      try {
        user = await Pi.authenticate(["username"], onIncompletePaymentFound);
        alert("GiriÅŸ baÅŸarÄ±lÄ±: " + user.username);
        payBtn.disabled = false;
      } catch (err) {
        alert("GiriÅŸ baÅŸarÄ±sÄ±z: " + err);
      }
    };

    // ðŸ”¹ Ã–deme
    payBtn.onclick = async () => {
      try {
        const payment = await Pi.createPayment({
          amount: 5.99,
          memo: "Spiritual Academy - Nefes ve Meditasyon",
          metadata: { course: "Nefes ve Meditasyon" },
        }, {
          onReadyForServerApproval,
          onReadyForServerCompletion,
          onCancel,
          onError,
        });

        function onReadyForServerApproval(paymentId) {
          fetch(backend + "/approve-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId }),
          });
        }

        function onReadyForServerCompletion(paymentId, txid) {
          fetch(backend + "/complete-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId, txid }),
          });
        }

        function onCancel() { alert("Ã–deme iptal edildi."); }
        function onError(err) { alert("Hata: " + err); }

        async function onIncompletePaymentFound(payment) {
          console.log("Eksik Ã¶deme bulundu:", payment);
        }
      } catch (err) {
        alert("Ã–deme baÅŸarÄ±sÄ±z: " + err);
      }
    };
  </script>
</body>
</html>
