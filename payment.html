<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Pi Test Ã–demesi â€” Spiritual Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; background:#f7f7fb; }
    .card { max-width:680px; margin:24px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.04) }
    button { font-size: 18px; padding: 12px 18px; margin-top: 12px; border-radius:10px; border:0; cursor:pointer; }
    .primary { background: linear-gradient(135deg,#7b61ff,#9a6bff); color:#fff; }
    .muted { color:#556; font-size:14px; margin-top:8px; }
    #log { margin-top:14px; font-size:13px; white-space:pre-wrap; color:#222; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Pi Test Ã–demesi â€” Spiritual Academy</h2>
    <p class="muted">Bu sayfa Pi Browser iÃ§inde test amaÃ§lÄ±dÄ±r. Ã–deme sunucu onayÄ± ile tamamlanÄ±r.</p>

    <div>
      <div id="productTitle" style="font-weight:600; margin-top:8px">ÃœrÃ¼n: <span id="pTitle">Test ÃœrÃ¼nÃ¼</span></div>
      <div id="productPrice" style="margin-top:6px; font-size:18px">Fiyat: <span id="pPrice">5.99</span> Pi</div>
      <button id="payBtn" class="primary">ğŸ’œ Ã–de</button>
      <div id="log"></div>
    </div>
  </div>

<script>
  // --- GÃ¼venlik/Ã¶n bilgi ---
  // Bu sayfa Pi SDK ile Ã¶deme baÅŸlatÄ±r ve backend uÃ§larÄ±na (aynÄ± origin) POST eder:
  // /approve-payment ve /complete-payment -> server.js tarafÄ±nda iÅŸlenir.
  // Query string ile parametre verilebilir:
  // ?amount=5.99&memo=Nefes&productId=breath-001

  // --- Pi SDK init (Mainnet) ---
  if (window.Pi) {
    try { window.Pi.init({ version: "2.0", sandbox: false }); } catch(e){ console.warn(e); }
  }

  const el = (id) => document.getElementById(id);
  const log = (m) => { el('log').innerText = (new Date().toLocaleTimeString()) + " â€” " + m; };

  // --- URL paramlarÄ±ndan oku (default deÄŸerler)
  const qs = new URLSearchParams(location.search);
  const rawAmount = parseFloat(qs.get('amount'));
  const amount = isNaN(rawAmount) ? 5.99 : rawAmount;
  const memo = qs.get('memo') ? decodeURIComponent(qs.get('memo')) : 'Hackathon Test Payment';
  const productId = qs.get('productId') || 'default-001';

  // UI'Ä± ayarla
  el('pTitle').innerText = memo;
  el('pPrice').innerText = amount;

  // Server POST helper (aynÄ± origin)
  async function post(path, bodyObj) {
    const r = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bodyObj || {})
    });
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch(e){ data = text; }
    if (!r.ok) throw { status: r.status, data };
    return data;
  }

  // Ã–deme workflow
  document.getElementById('payBtn').onclick = async () => {
    try {
      // Pi Browser kontrolÃ¼
      if (!window.Pi) {
        log("Hata: LÃ¼tfen Pi Browser iÃ§inde aÃ§Ä±n.");
        alert("Bu sayfayÄ± Pi Browser iÃ§inde aÃ§Ä±n.");
        return;
      }

      log("Auth isteniyor...");
      // authenticate (payments scope)
      await window.Pi.authenticate(['payments']).catch(()=>{ /* kullanÄ±cÄ± iptal edebilir */ });

      log("Ã–deme baÅŸlatÄ±lÄ±yor...");

      const paymentData = {
        amount: amount,
        memo: memo,
        metadata: { productId }
      };

      const callbacks = {
        onReadyForServerApproval: async (paymentId) => {
          log("Sunucu onayÄ± bekleniyorâ€¦ paymentId: " + paymentId);
          try {
            await post('/approve-payment', { paymentId });
            log("Sunucu onaylandÄ±.");
          } catch(e) {
            console.error(e);
            log("Sunucu onayÄ± baÅŸarÄ±sÄ±z: " + JSON.stringify(e));
            alert("Sunucu onayÄ± baÅŸarÄ±sÄ±z. Konsolu kontrol et.");
          }
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          log("Tamamlama bekleniyorâ€¦ paymentId: " + paymentId + " txid: " + txid);
          try {
            await post('/complete-payment', { paymentId, txid });
            log("Ã–deme baÅŸarÄ±yla tamamlandÄ±.");
            alert("Ã–deme baÅŸarÄ±lÄ±. TeÅŸekkÃ¼rler!");
          } catch(e) {
            console.error(e);
            log("Tamamlama baÅŸarÄ±sÄ±z: " + JSON.stringify(e));
            alert("Tamamlama baÅŸarÄ±sÄ±z. Konsolu kontrol et.");
          }
        },
        onCancel: (paymentId) => {
          log("KullanÄ±cÄ± iptal etti. paymentId: " + paymentId);
        },
        onError: (err, paymentId) => {
          console.error(err);
          log("SDK Hata: " + (err?.message || err) + " paymentId: " + paymentId);
          alert("Ã–deme hatasÄ±: " + (err?.message || err));
        }
      };

      // SDK Ã§aÄŸrÄ±sÄ±
      await window.Pi.createPayment(paymentData, callbacks);
      log("SDK Ã¶deme akÄ±ÅŸÄ± baÅŸlatÄ±ldÄ±, cÃ¼zdan ekranÄ±nÄ± takip edin.");
    } catch (err) {
      console.error(err);
      log("Ã–deme baÅŸlatÄ±lamadÄ±: " + (err?.message || err));
      alert("Ã–deme baÅŸlatÄ±lamadÄ±: " + (err?.message || err));
    }
  };
</script>
</body>
</html>
