<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Pi Ã–demesi â€” Spiritual Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; background:#f7f7fb; }
    .card { max-width:680px; margin:24px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.04) }
    button { font-size: 18px; padding: 12px 18px; margin-top: 12px; border-radius:10px; border:0; cursor:pointer; }
    .primary { background: linear-gradient(135deg,#7b61ff,#9a6bff); color:#fff; }
    .muted { color:#556; font-size:14px; margin-top:8px; }
    #log { margin-top:14px; font-size:13px; white-space:pre-wrap; color:#222; }
    .row { margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h2 id="t-title">Pi Ã–demesi â€” Spiritual Academy</h2>
    <p class="muted" id="t-subtitle">Bu sayfa Pi Browser iÃ§inde test amaÃ§lÄ±dÄ±r. Ã–deme sunucu onayÄ± ile tamamlanÄ±r.</p>

    <div class="row">
      <div style="font-weight:600;"><span id="t-product">ÃœrÃ¼n</span>: <span id="pTitle">Test ÃœrÃ¼nÃ¼</span></div>
      <div style="font-size:18px"><span id="t-price">Fiyat</span>: <span id="pPrice">5.99</span> Pi</div>
      <button id="payBtn" class="primary">ğŸ’œ <span id="t-pay">Ã–de</span></button>
      <div id="log"></div>
    </div>
  </div>

<script>
  // ---------- I18N ----------
  const qs = new URLSearchParams(location.search);
  const langParam = (qs.get('lang') || '').toLowerCase();

  async function loadI18n() {
    try {
      const url = langParam ? `/i18n/${langParam}.json` : '/i18n/auto.json';
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error('i18n fetch failed');
      return await r.json();
    } catch {
      return {}; // fallback: boÅŸ sÃ¶zlÃ¼k -> varsayÄ±lan TÃ¼rkÃ§e metinler kalÄ±r
    }
  }
  function t(dict, key, fallback) {
    return (dict && dict[key]) ? dict[key] : fallback;
  }

  // ---------- Pi SDK ----------
  if (window.Pi) {
    try { window.Pi.init({ version: "2.0", sandbox: false }); } catch(e){ console.warn(e); }
  }

  const el = (id) => document.getElementById(id);
  const log = (m) => { el('log').innerText = (new Date().toLocaleTimeString()) + " â€” " + m; };

  // URL parametreleri (varsayÄ±lanlar)
  const rawAmount = parseFloat(qs.get('amount'));
  const amount = isNaN(rawAmount) ? 5.99 : rawAmount;
  const memo = qs.get('memo') ? decodeURIComponent(qs.get('memo')) : 'Hackathon Payment';
  const productId = qs.get('productId') || 'default-001';

  // UI deÄŸerlerini hazÄ±rla
  el('pTitle').innerText = memo;
  el('pPrice').innerText = amount;

  // I18N yÃ¼kle ve metinleri uygula
  loadI18n().then(dict => {
    el('t-title').innerText   = t(dict, 'pay_title',   'Pi Ã–demesi â€” Spiritual Academy');
    el('t-subtitle').innerText= t(dict, 'pay_subtitle','Bu sayfa Pi Browser iÃ§inde test amaÃ§lÄ±dÄ±r. Ã–deme sunucu onayÄ± ile tamamlanÄ±r.');
    el('t-product').innerText = t(dict, 'label_product','ÃœrÃ¼n');
    el('t-price').innerText   = t(dict, 'label_price',  'Fiyat');
    el('t-pay').innerText     = t(dict, 'btn_pay',      'Ã–de');
  });

  // Sunucu POST helper (aynÄ± origin)
  async function post(path, bodyObj) {
    const r = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bodyObj || {})
    });
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch(e){ data = text; }
    if (!r.ok) throw { status: r.status, data };
    return data;
  }

  // Ã–deme akÄ±ÅŸÄ±
  document.getElementById('payBtn').onclick = async () => {
    try {
      if (!window.Pi) {
        log("Hata: LÃ¼tfen bu sayfayÄ± Pi Browser iÃ§inde aÃ§Ä±n.");
        alert("LÃ¼tfen Pi Browser iÃ§inde aÃ§Ä±n.");
        return;
      }

      log("Kimlik doÄŸrulama isteniyorâ€¦");
      await window.Pi.authenticate(['payments']).catch(()=>{ /* kullanÄ±cÄ± iptal edebilir */ });

      log("Ã–deme baÅŸlatÄ±lÄ±yorâ€¦");
      const paymentData = {
        amount,
        memo,
        metadata: { productId }
      };

      const callbacks = {
        onReadyForServerApproval: async (paymentId) => {
          log("Sunucu onayÄ± bekleniyorâ€¦ paymentId: " + paymentId);
          try {
            await post('/approve-payment', { paymentId });
            log("Sunucu onaylandÄ±.");
          } catch(e) {
            console.error(e);
            log("Sunucu onayÄ± baÅŸarÄ±sÄ±z: " + JSON.stringify(e));
            alert("Sunucu onayÄ± baÅŸarÄ±sÄ±z.");
          }
        },
        onReadyForServerCompletion: async (paymentId, txid) => {
          log("Tamamlama bekleniyorâ€¦ paymentId: " + paymentId + " txid: " + txid);
          try {
            await post('/complete-payment', { paymentId, txid });
            log("Ã–deme baÅŸarÄ±yla tamamlandÄ±.");
            alert("Ã–deme baÅŸarÄ±lÄ±. TeÅŸekkÃ¼rler!");
          } catch(e) {
            console.error(e);
            log("Tamamlama baÅŸarÄ±sÄ±z: " + JSON.stringify(e));
            alert("Tamamlama baÅŸarÄ±sÄ±z.");
          }
        },
        onCancel: (paymentId) => {
          log("KullanÄ±cÄ± iptal etti. paymentId: " + paymentId);
        },
        onError: (err, paymentId) => {
          console.error(err);
          log("SDK Hata: " + (err?.message || err) + " paymentId: " + paymentId);
          alert("Ã–deme hatasÄ±: " + (err?.message || err));
        }
      };

      await window.Pi.createPayment(paymentData, callbacks);
      log("CÃ¼zdan ekranÄ±nÄ± takip edin.");
    } catch (err) {
      console.error(err);
      log("Ã–deme baÅŸlatÄ±lamadÄ±: " + (err?.message || err));
      alert("Ã–deme baÅŸlatÄ±lamadÄ±: " + (err?.message || err));
    }
  };
</script>
</body>
</html>
