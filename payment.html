<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pi Test Ödemesi</title>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; padding:24px}
    h1{margin:0 0 8px}
    p{margin:0 0 16px}
    button{font-size:18px;padding:12px 18px;border-radius:10px;border:1px solid #ddd}
    #log{margin-top:18px;font-size:14px;white-space:pre-line}
    .ok{color:#0a7f38}
    .err{color:#b00020}
  </style>
</head>

<body>
  <h1>Pi Test Ödemesi</h1>
  <p>Bu sayfa yalnızca 10. adımı tamamlamak için test amaçlıdır.</p>

  <button id="payBtn">0.01 Test-π ile Öde</button>
  <div id="log"></div>

  <script>
    // === AYARLAR ===
    // Backend’in (Render) kök adresi:
    const BACKEND = "https://spiritual-academy.onrender.com";

    // Küçük yardımcılar
    const logBox = document.getElementById("log");
    const log = (msg, cls="") => {
      const line = document.createElement("div");
      if (cls) line.className = cls;
      line.textContent = msg;
      logBox.appendChild(line);
    };

    // Pi Browser dışında açılırsa uyar
    if (!window.Pi) {
      log("Lütfen bu sayfayı Pi Browser içinde açın.", "err");
    } else {
      // SDK'yı başlat
      Pi.init({ version: "2.0" });

      // (Opsiyonel) auth – bazı kurulumlarda gerekebilir
      const scopes = ["payments","username"];
      Pi.authenticate(scopes).catch(()=>{ /* sessiz geç */ });
    }

    // ÖDEME AKIŞI
    document.getElementById("payBtn").onclick = async () => {
      logBox.innerHTML = "";
      log("Ödeme başlatılıyor…");

      try {
        await Pi.createPayment(
          // 1) Ödeme bilgileri
          {
            amount: 0.01,                          // Test-π
            memo: "Hackathon Test Payment",        // Gösterilecek not
            metadata: { source: "payment.html" }   // İstersen ek bilgi
          },

          // 2) Sunucu onayı ISTE
          {
            onReadyForServerApproval: async (paymentId) => {
              log("Onay bekleniyor…\nPaymentID: " + paymentId);

              const r = await fetch(`${BACKEND}/approve-payment`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId })
              });

              if (!r.ok) throw new Error("Sunucu onayı başarısız (approve-payment).");
              const data = await r.json();
              if (!data.approved) throw new Error("Ödeme sunucu tarafından reddedildi.");
              log("Sunucu onayı alındı.", "ok");
            },

            // 3) Sunucu TAMAMLAMA ISTE
            onReadyForServerCompletion: async (paymentId) => {
              log("Tamamlanıyor…\nPaymentID: " + paymentId);

              const r = await fetch(`${BACKEND}/complete-payment`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId })
              });

              if (!r.ok) throw new Error("Sunucu tamamlama başarısız (complete-payment).");
              const data = await r.json();
              if (!data.completed) throw new Error("Ödeme sunucu tarafından tamamlanmadı.");
              log("Ödeme tamamlandı ✅", "ok");
            },

            // 4) İPTAL
            onCancel: async (paymentId) => {
              log("İptal edildi.\nPaymentID: " + paymentId, "err");
              // bilgilendirme için backend’e haber göndermek istersen:
              try {
                await fetch(`${BACKEND}/cancel-payment`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ paymentId })
                });
              } catch (_) {}
            }
          }
        );
      } catch (err) {
        log("Hata: " + (err?.message || String(err)), "err");
      }
    };
  </script>
</body>
</html>
